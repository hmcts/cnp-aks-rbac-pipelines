{"tasks":[{"environment":{},"displayName":"Deploy AKS Cluster","alwaysRun":false,"continueOnError":false,"condition":"eq(variables['Deploy.Cluster'],'true')","enabled":true,"timeoutInMinutes":0,"inputs":{"ConnectedServiceName":"$(Task.Subscription)","action":"Create Or Update Resource Group","resourceGroupName":"$(Task.AKS.ResourceGroup)","location":"$(Task.Location)","templateLocation":"Linked artifact","csmFileLink":"","csmParametersFileLink":"","csmFile":"$(System.DefaultWorkingDirectory)/_aks-rbac-pipelines-CI/drop/templates/arm-aks-template.json","csmParametersFile":"","overrideParameters":"-aksClusterName $(Task.AKS.ClusterName) -aksVnetSubnetId $(Task.AKS.SubnetId) -dnsPrefix $(Task.AKS.ClusterName) -sshPublicKey \"$(Task.AKS.SshPublicKey)\" -servicePrincipalId $(Task.AKS.Sp.Id) -servicePrincipalSecret $(Task.AKS.Sp.Secret) -clientAppId $(Task.AKS.Client.Id) -serverAppId $(Task.AKS.ServerApp.Id) -serverAppSecret $(Task.AKS.ServerApp.Secret) -aksLogAnalyticsId $(Task.Workspace.Id) -environmentName $(Release.Environmentname) -branch $(Build.SourceBranchName) -managedBy \\\"$(Task.Tags.ManagedBy)\\\" -solutionOwner \\\"$(Task.Tags.SolutionOwner)\\\" -activityName \\\"$(Task.Tags.ActivityName)\\\" -dataClassification \\\"$(Task.Tags.DataClassification)\\\" -automation \\\"$(Task.Tags.Automation)\\\" -costCentre \\\"$(Task.Tags.CostCentre)\\\" -environment \\\"$(Task.Tags.Environment)\\\" -criticality \\\"$(Task.Tags.Criticality)\\\"","deploymentMode":"Incremental","enableDeploymentPrerequisites":"None","deploymentGroupEndpoint":"","project":"","deploymentGroupName":"","copyAzureVMTags":"true","runAgentServiceAsUser":"false","userName":"","password":"","outputVariable":"","deploymentName":"","deploymentOutputs":"aksOutputs","addSpnToEnvironment":"false"},"task":{"id":"94a74903-f93f-4075-884f-dc11f34058b4","versionSpec":"2.*","definitionType":"task"}},{"environment":{},"displayName":"Parse aksOutputs Outputs","alwaysRun":false,"continueOnError":false,"condition":"eq(variables['Deploy.Cluster'],'true')","enabled":true,"timeoutInMinutes":0,"inputs":{"targetType":"filePath","filePath":"$(System.DefaultWorkingDirectory)/_aks-rbac-pipelines-CI/drop/scripts/publish-arm-outputs.sh","arguments":"'$(aksOutputs)'","script":"# Write your commands here\n\n# Use the environment variables input below to pass secret variables to this script","workingDirectory":"","failOnStderr":"false","noProfile":"true","noRc":"true"},"task":{"id":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","versionSpec":"3.*","definitionType":"task"}},{"environment":{},"displayName":"Publish AKS clusterID if found","alwaysRun":false,"continueOnError":true,"condition":"and(not(variables['aksid']),ne(variables['Deploy.Cluster'],'true'))","enabled":true,"timeoutInMinutes":0,"inputs":{"connectedServiceNameARM":"$(Task.Subscription)","scriptLocation":"scriptPath","scriptPath":"$(System.DefaultWorkingDirectory)/_aks-rbac-pipelines-CI/drop/scripts/publish-aks-clusterid.sh","inlineScript":"","args":"$(Task.AKS.ClusterName) $(Task.AKS.ResourceGroup)","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"$(System.DefaultWorkingDirectory)/_aks-rbac-pipelines-CI/drop","failOnStandardError":"false"},"task":{"id":"46e4be58-730b-4389-8a2f-ea10b3e5e815","versionSpec":"1.*","definitionType":"task"}},{"environment":{},"displayName":"Get AKS credentials","alwaysRun":false,"continueOnError":true,"condition":"succeeded()","enabled":true,"timeoutInMinutes":0,"inputs":{"connectedServiceNameARM":"$(Task.Subscription)","scriptLocation":"scriptPath","scriptPath":"$(System.DefaultWorkingDirectory)/_aks-rbac-pipelines-CI/drop/scripts/get-aks-credentials.sh","inlineScript":"","args":"\"$(Task.AKS.ResourceGroup)\" \"$(Task.AKS.ClusterName)\"","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"","failOnStandardError":"false"},"task":{"id":"46e4be58-730b-4389-8a2f-ea10b3e5e815","versionSpec":"1.*","definitionType":"task"}},{"environment":{},"displayName":"Enable monitoring","alwaysRun":false,"continueOnError":true,"condition":"eq(variables['Deploy.Cluster'],'true')","enabled":true,"timeoutInMinutes":0,"inputs":{"connectedServiceNameARM":"$(Task.Subscription)","scriptLocation":"scriptPath","scriptPath":"$(System.DefaultWorkingDirectory)/_aks-rbac-pipelines-CI/drop/scripts/enable-aks-monitor.sh","inlineScript":"","args":"\"$(Task.Workspace.Id)\" \"$(aksId)\"","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"","failOnStandardError":"false"},"task":{"id":"46e4be58-730b-4389-8a2f-ea10b3e5e815","versionSpec":"1.*","definitionType":"task"}},{"environment":{},"displayName":"Create Custom Namespaces","alwaysRun":false,"continueOnError":false,"condition":"eq(variables['Deploy.Cluster'],'true')","enabled":true,"timeoutInMinutes":0,"inputs":{"targetType":"filePath","filePath":"$(System.DefaultWorkingDirectory)/_aks-rbac-pipelines-CI/drop/scripts/create-custom-namespaces.sh","arguments":"","script":"# Write your commands here\n\n# Use the environment variables input below to pass secret variables to this script","workingDirectory":"$(System.DefaultWorkingDirectory)/_aks-rbac-pipelines-CI/drop","failOnStderr":"false","noProfile":"true","noRc":"true"},"task":{"id":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","versionSpec":"3.*","definitionType":"task"}},{"environment":{},"displayName":"Flux - Template secret","alwaysRun":false,"continueOnError":false,"condition":"eq(variables['Deploy.Cluster'],'true')","enabled":true,"timeoutInMinutes":0,"inputs":{"targetType":"filePath","filePath":"$(System.DefaultWorkingDirectory)/_aks-rbac-pipelines-CI/drop/scripts/customise-flux-repositories.sh","arguments":"\"$(Task.AcrName)\" \"$(Task.AKS.Sp.Id)\" \"$(Task.AKS.Sp.Secret)\"","script":"# Write your commands here\n\n# Use the environment variables input below to pass secret variables to this script","workingDirectory":"$(System.DefaultWorkingDirectory)/_aks-rbac-pipelines-CI/drop","failOnStderr":"false","noProfile":"true","noRc":"true"},"task":{"id":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","versionSpec":"3.*","definitionType":"task"}},{"environment":{},"displayName":"Bind admin roles","alwaysRun":false,"continueOnError":true,"condition":"eq(variables['Deploy.Cluster'],'true')","enabled":true,"timeoutInMinutes":0,"inputs":{"connectedServiceNameARM":"$(Task.Subscription)","scriptLocation":"scriptPath","scriptPath":"$(System.DefaultWorkingDirectory)/_aks-rbac-pipelines-CI/drop/scripts/create-cluster-admins.sh","inlineScript":"","args":"$(Task.AKS.ClusterName)","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"$(System.DefaultWorkingDirectory)/_aks-rbac-pipelines-CI/drop","failOnStandardError":"false"},"task":{"id":"46e4be58-730b-4389-8a2f-ea10b3e5e815","versionSpec":"1.*","definitionType":"task"}},{"environment":{},"displayName":"Bind developers roles","alwaysRun":false,"continueOnError":true,"condition":"eq(variables['Deploy.Cluster'],'true')","enabled":true,"timeoutInMinutes":0,"inputs":{"connectedServiceNameARM":"$(Task.Subscription)","scriptLocation":"scriptPath","scriptPath":"$(System.DefaultWorkingDirectory)/_aks-rbac-pipelines-CI/drop/scripts/create-developer-roles.sh","inlineScript":"","args":"","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"$(System.DefaultWorkingDirectory)/_aks-rbac-pipelines-CI/drop","failOnStandardError":"false"},"task":{"id":"46e4be58-730b-4389-8a2f-ea10b3e5e815","versionSpec":"1.*","definitionType":"task"}},{"environment":{},"displayName":"Remove dashboard","alwaysRun":false,"continueOnError":true,"condition":"eq(variables['Deploy.Cluster'],'true')","enabled":true,"timeoutInMinutes":0,"inputs":{"connectedServiceNameARM":"$(Task.Subscription)","scriptLocation":"scriptPath","scriptPath":"$(System.DefaultWorkingDirectory)/_aks-rbac-pipelines-CI/drop/scripts/remove-dashboard.sh","inlineScript":"","args":"","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"$(System.DefaultWorkingDirectory)/_aks-rbac-pipelines-CI/drop","failOnStandardError":"false"},"task":{"id":"46e4be58-730b-4389-8a2f-ea10b3e5e815","versionSpec":"1.*","definitionType":"task"}}],"runsOn":["Agent","DeploymentGroup"],"revision":3,"createdBy":{"displayName":"Martin Palmer","id":"b0b049d4-4962-60c3-b214-94ae9fb50f1c","uniqueName":"Martin.Palmer@HMCTS.NET"},"createdOn":"2019-05-17T12:12:33.447Z","modifiedBy":{"displayName":"Martin Palmer","id":"b0b049d4-4962-60c3-b214-94ae9fb50f1c","uniqueName":"Martin.Palmer@HMCTS.NET"},"modifiedOn":"2019-05-19T20:40:35.283Z","comment":"","id":"bf3a7da1-8191-4c32-83ea-ab5fb4a63dea","name":"AKS-Cluster","version":{"major":1,"minor":0,"patch":0,"isTest":false},"iconUrl":"https://cdn.vsassets.io/v/M151_20190503.6/_content/icon-meta-task.png","friendlyName":"AKS-Cluster","description":"","category":"Deploy","definitionType":"metaTask","author":"Martin Palmer","demands":[],"groups":[],"inputs":[{"aliases":[],"options":{},"properties":{},"name":"Task.AcrName","label":"Task.AcrName","defaultValue":"$(acrName)","required":true,"type":"string","helpMarkDown":"","groupName":""},{"aliases":[],"options":{},"properties":{},"name":"Task.AKS.Client.Id","label":"Task.AKS.Client.Id","defaultValue":"$(aks-client-app-id)","required":true,"type":"string","helpMarkDown":"","groupName":""},{"aliases":[],"options":{},"properties":{},"name":"Task.AKS.ClusterName","label":"Task.AKS.ClusterName","defaultValue":"","required":true,"type":"string","helpMarkDown":"","groupName":""},{"aliases":[],"options":{},"properties":{},"name":"Task.AKS.ResourceGroup","label":"Task.AKS.ResourceGroup","defaultValue":"","required":true,"type":"string","helpMarkDown":"","groupName":""},{"aliases":[],"options":{},"properties":{},"name":"Task.AKS.ServerApp.Id","label":"Task.AKS.ServerApp.Id","defaultValue":"$(aks-server-app-id)","required":true,"type":"string","helpMarkDown":"","groupName":""},{"aliases":[],"options":{},"properties":{},"name":"Task.AKS.ServerApp.Secret","label":"Task.AKS.ServerApp.Secret","defaultValue":"$(aks-server-app-password)","required":true,"type":"string","helpMarkDown":"","groupName":""},{"aliases":[],"options":{},"properties":{},"name":"Task.AKS.Sp.Id","label":"Task.AKS.Sp.Id","defaultValue":"$(aks-sp-app-id)","required":true,"type":"string","helpMarkDown":"","groupName":""},{"aliases":[],"options":{},"properties":{},"name":"Task.AKS.Sp.Secret","label":"Task.AKS.Sp.Secret","defaultValue":"$(aks-sp-app-password)","required":true,"type":"string","helpMarkDown":"","groupName":""},{"aliases":[],"options":{},"properties":{},"name":"Task.AKS.SshPublicKey","label":"Task.AKS.SshPublicKey","defaultValue":"$(aks-ssh-pub-key)","required":true,"type":"string","helpMarkDown":"","groupName":""},{"aliases":[],"options":{},"properties":{},"name":"Task.AKS.SubnetId","label":"Task.AKS.SubnetId","defaultValue":"","required":true,"type":"string","helpMarkDown":"","groupName":""},{"aliases":[],"options":{},"properties":{"EditableOptions":"True"},"name":"Task.Location","label":"Task.Location","defaultValue":"$(Env.Location)","required":true,"type":"pickList","helpMarkDown":"Location for deploying the resource group. If the resource group already exists in the subscription, then this value will be ignored.","groupName":""},{"aliases":[],"options":{},"properties":{},"name":"Task.Subscription","label":"Task.Subscription","defaultValue":"$(Subscription.ServiceConnection.Name)","required":true,"type":"connectedService:AzureRM","helpMarkDown":"Select the Azure Resource Manager subscription for the deployment.","groupName":""},{"aliases":[],"options":{},"properties":{},"name":"Task.Tags.ActivityName","label":"Task.Tags.ActivityName","defaultValue":"$(activityName)","required":true,"type":"string","helpMarkDown":"","groupName":""},{"aliases":[],"options":{},"properties":{},"name":"Task.Tags.Automation","label":"Task.Tags.Automation","defaultValue":"$(automation)","required":true,"type":"string","helpMarkDown":"","groupName":""},{"aliases":[],"options":{},"properties":{},"name":"Task.Tags.CostCentre","label":"Task.Tags.CostCentre","defaultValue":"$(costCentre)","required":true,"type":"string","helpMarkDown":"","groupName":""},{"aliases":[],"options":{},"properties":{},"name":"Task.Tags.Criticality","label":"Task.Tags.Criticality","defaultValue":"$(criticality)","required":true,"type":"string","helpMarkDown":"","groupName":""},{"aliases":[],"options":{},"properties":{},"name":"Task.Tags.DataClassification","label":"Task.Tags.DataClassification","defaultValue":"$(dataClassification)","required":true,"type":"string","helpMarkDown":"","groupName":""},{"aliases":[],"options":{},"properties":{},"name":"Task.Tags.Environment","label":"Task.Tags.Environment","defaultValue":"$(environment)","required":true,"type":"string","helpMarkDown":"","groupName":""},{"aliases":[],"options":{},"properties":{},"name":"Task.Tags.ManagedBy","label":"Task.Tags.ManagedBy","defaultValue":"$(managedBy)","required":true,"type":"string","helpMarkDown":"","groupName":""},{"aliases":[],"options":{},"properties":{},"name":"Task.Tags.SolutionOwner","label":"Task.Tags.SolutionOwner","defaultValue":"$(solutionOwner)","required":true,"type":"string","helpMarkDown":"","groupName":""},{"aliases":[],"options":{},"properties":{},"name":"Task.Workspace.Id","label":"Task.Workspace.Id","defaultValue":"$(workspaceID)","required":true,"type":"string","helpMarkDown":"","groupName":""}],"satisfies":[],"sourceDefinitions":[],"dataSourceBindings":[],"instanceNameFormat":"Task group: AKS-Cluster $(aksId)","preJobExecution":{},"execution":{},"postJobExecution":{}}