  - task: DownloadSecureFile@1
    displayName: 'Download cluster sealed secret key'
    inputs:
      secureFile: $(aksResourceGroup)-cluster-sealed-secret.key

- task: AzureCLI@1
    displayName: 'Replace sealed secret key'
    inputs:
      azureSubscription: $(serviceConnection)
      scriptLocation: 'inlineScript'
      inlineScript: |
        ls -la $(Agent.TempDirectory)
        kubectl replace secret -n admin sealed-secrets-key -f $(Agent.TempDirectory)/$(aksResourceGroup)-cluster-sealed-secret.key
        kubectl delete pod -n admin -l app.kubernetes.io/name=sealed-secrets || true
  - task: AzureCLI@1
    displayName: 'Install Sealed Secrets'
    inputs:
      azureSubscription: $(serviceConnection)
      scriptLocation: 'inlineScript'
      inlineScript: |
        helm upgrade sealed-secrets stable/sealed-secrets --install --namespace admin \
          --set image.repository=quay.io/bitnami/sealed-secrets-controller,image.tag=v0.7.0 \
          --wait